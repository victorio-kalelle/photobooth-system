<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Photobooth</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/photobooth.css') }}">
</head>

<body>
    <div class="holder">
        <div class="booth-container">

            <div class="camera-section">
                <video id="video" autoplay></video>
            </div>

            <div id="finalFrame" class="final-frame"></div>
        </div>

        <div class="button-wrapper">
            <button id="captureBtn" class="btn">ðŸ“·</button>
        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const captureBtn = document.getElementById("captureBtn");
        const finalFrame = document.getElementById("finalFrame");

        const selectedLayout = parseInt(localStorage.getItem("selectedLayout") || "1");
        const selectedFrameColor = localStorage.getItem("selectedFrameColor") || "#FFFFFF";

        let shots = [];

        function createLayout() {
            finalFrame.innerHTML = "";
            finalFrame.style.backgroundColor = selectedFrameColor;
            finalFrame.className = "final-frame";

            const cameraHeight = document.querySelector(".camera-section video").offsetHeight;
            finalFrame.style.height = cameraHeight + "px";

            const gapCount = selectedLayout - 1;
            const gapTotal = gapCount * 10;
            const slotHeight = (cameraHeight - gapTotal) / selectedLayout;

            for (let i = 0; i < selectedLayout; i++) {
                const slot = document.createElement("div");
                slot.classList.add("photo-slot");
                slot.style.height = slotHeight + "px";
                finalFrame.appendChild(slot);
            }
        }

        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
            video.addEventListener('loadedmetadata', createLayout);
        });

        captureBtn.addEventListener("click", () => {
            if (shots.length >= selectedLayout) return;

            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext("2d");
            context.drawImage(video, 0, 0);

            const imgData = canvas.toDataURL("image/png");
            shots.push(imgData);

            const slot = finalFrame.querySelectorAll(".photo-slot")[shots.length - 1];
            const img = document.createElement("img");
            img.src = imgData;
            slot.appendChild(img);

            if (shots.length === selectedLayout) {
                captureBtn.textContent = "Done";
                captureBtn.removeEventListener("click", captureBtnHandler);
                captureBtn.addEventListener("click", savePhotos);
                stopCamera();
            }
        });

        function captureBtnHandler() {
            // placeholder if needed, removed to avoid double listener
        }

        function savePhotos() {
            fetch("/save_photos", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    images: shots,
                    layout: selectedLayout,
                    frameColor: selectedFrameColor
                })
            }).then(res => res.json())
              .then(data => {
                  alert(`Photos saved as: ${data.filename}`);
              });
        }

        function stopCamera() {
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
        }
    </script>
</body>

</html>
